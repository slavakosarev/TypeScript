import { renderBlock } from './lib.js';
import { renderSearchResultsBlock } from './search-results.js';
import { FlatrentProvider } from './store/providers/flatrent/flatrent-provider.js';
import { HomyProvider } from './store/providers/homy/homy-provider.js';
import { toggleFavoriteItem } from './toggleFavorite.js';
const flatrentProvider = new FlatrentProvider();
const homyProvider = new HomyProvider();
export function CallBack(value) {
    if (Math.random() >= 0.5) {
        throw Error("value");
        ;
    }
    return [];
}
;
export function sortPlaces(arr, sort) {
    function sortBy(one, two) {
        if (one[sort.key] > two[sort.key]) {
            return sort.by;
        }
        else if (one[sort.key] < two[sort.key]) {
            return -sort.by;
        }
        else {
            return 0;
        }
    }
    return arr.sort(sortBy);
}
export function search(formName, cb = function () { }) {
    const form = document.getElementById(formName);
    const data = {
        'startDate': form['check-in-date'].value,
        'endDate': form['check-out-date'].value,
        'flatRent': form['flat-rent'].checked,
        'homy': form['homy'].checked
    };
    findData(data);
    setTimeout(cb, 3000);
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        let data = {
            'startDate': form['check-in-date'].value,
            'endDate': form['check-out-date'].value,
            'maxPrice': form['max-price'].value || null,
            'flatRent': form['flat-rent'].checked,
            'homy': form['homy'].checked
        };
        findData(data);
    });
}
export function findData(data, sortParams) {
    Promise.all([
        flatrentProvider.search({
            city: 'Санкт-Петербург',
            checkInDate: new Date(data['startDate']),
            checkOutDate: new Date(data['endDate']),
            priceLimit: data['maxPrice']
        }),
        homyProvider.search({
            city: [59.9386, 30.3141],
            checkInDate: new Date(data['startDate']),
            checkOutDate: new Date(data['endDate']),
            priceLimit: data['maxPrice']
        })
    ]).then((results) => {
        let allResults = [];
        if (data['flatRent'] && data['homy']) {
            allResults = [].concat(results[0], results[1]);
        }
        else {
            if (data['flatRent']) {
                allResults = [].concat(results[0]);
            }
            if (data['homy']) {
                allResults = [].concat(results[1]);
            }
        }
        sortPlaces(allResults, sortParams || { key: "price", by: 1, value: "Сначала дешёвые" });
        renderSearchResultsBlock(allResults, (sortParams === null || sortParams === void 0 ? void 0 : sortParams.value) || "Сначала дешёвые");
        toggleFavoriteItem();
        const sort = document.getElementById("sort");
        sort.addEventListener('change', (e) => {
            e.preventDefault();
            const target = e.target;
            switch (target.value) {
                case "Сначала дорогие":
                    findData(data, { key: "price", by: -1, value: target.value });
                    break;
                case "Сначала дешёвые":
                    findData(data, { key: "price", by: 1, value: target.value });
                    break;
                case "Сначала ближе":
                    findData(data, { key: "remoteness", by: 1, value: target.value });
                    break;
            }
        });
    });
}
export function renderSearchFormBlock(data) {
    let currentDate = new Date();
    let minDate = `${currentDate.getFullYear()}-${('0' + (currentDate.getMonth() + 1)).slice(-2)}-${currentDate.getDate()}`;
    let maxDateFull = new Date(currentDate.getFullYear(), currentDate.getMonth() + 2, 0);
    let maxDate = `${maxDateFull.getFullYear()}-${('0' + (maxDateFull.getMonth() + 1)).slice(-2)}-${maxDateFull.getDate()}`;
    if (!data.startDate) {
        data.startDate = `${new Date(currentDate).getFullYear()}-${('0' + (currentDate.getMonth() + 1)).slice(-2)}-${('0' + (new Date(currentDate).getDate() + 1)).slice(-2)}`;
    }
    if (!data.endDate) {
        data.endDate = `${new Date(currentDate).getFullYear()}-${('0' + (currentDate.getMonth() + 1)).slice(-2)}-${('0' + (new Date(currentDate).getDate() + 2)).slice(-2)}`;
    }
    renderBlock('search-form-block', `
    <form id="search">
      <fieldset class="search-filedset">
        <div class="row">
          <div>
            <label for="city">Город</label>
            <input id="city" type="text" disabled value="Санкт-Петербург" />
            <input type="hidden" disabled value="59.9386,30.3141" />
          </div>
          <div class="providers">
            <label><input type="checkbox" name="provider" value="homy" id="homy" checked /> Homy</label>
            <label><input type="checkbox" name="provider" value="flat-rent" id="flat-rent" checked /> FlatRent</label>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="check-in-date">Дата заезда</label>
            <input id="check-in-date" type="date" value="${data.startDate}" min="${minDate}" max="${maxDate}" name="checkin" />
          </div>
          <div>
            <label for="check-out-date">Дата выезда</label>
            <input id="check-out-date" type="date" value="${data.endDate}" min="${data.startDate}" max="${maxDate}" name="checkout" />
          </div>
          <div>
            <label for="max-price">Макс. цена суток</label>
            <input id="max-price" type="number" value="" name="price" class="max-price" />
          </div>
          <div>
            <div><button>Найти</button></div>
          </div>
        </div>
      </fieldset>
    </form>
    `);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLWZvcm0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2VhcmNoLWZvcm0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUV2QyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpREFBaUQsQ0FBQztBQUNuRixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFDdkUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFekQsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLGdCQUFnQixFQUFFLENBQUE7QUFDL0MsTUFBTSxZQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQTtBQWdCdkMsTUFBTSxVQUFVLFFBQVEsQ0FBQyxLQUFxQjtJQUM1QyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxHQUFHLEVBQUU7UUFDeEIsTUFBTSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFBQSxDQUFDO0tBQ3ZCO0lBQ0QsT0FBTyxFQUFFLENBQUE7QUFDWCxDQUFDO0FBQUEsQ0FBQztBQUVGLE1BQU0sVUFBVSxVQUFVLENBQUMsR0FBWSxFQUFFLElBQWdCO0lBQ3ZELFNBQVMsTUFBTSxDQUFDLEdBQVUsRUFBRSxHQUFVO1FBQ3BDLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2pDLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQTtTQUNmO2FBQU0sSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDeEMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUE7U0FDaEI7YUFBTTtZQUNMLE9BQU8sQ0FBQyxDQUFBO1NBQ1Q7SUFDSCxDQUFDO0lBQ0QsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0FBQ3pCLENBQUM7QUFFRCxNQUFNLFVBQVUsTUFBTSxDQUFDLFFBQWdCLEVBQUUsS0FBZSxjQUFjLENBQUM7SUFDckUsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUUvQyxNQUFNLElBQUksR0FBRztRQUNYLFdBQVcsRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsS0FBSztRQUN4QyxTQUFTLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsS0FBSztRQUN2QyxVQUFVLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU87UUFDckMsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPO0tBQzdCLENBQUM7SUFDRixRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDZixVQUFVLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3JCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRTtRQUNwQyxDQUFDLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDbkIsSUFBSSxJQUFJLEdBQUc7WUFDVCxXQUFXLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLEtBQUs7WUFDeEMsU0FBUyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEtBQUs7WUFDdkMsVUFBVSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxLQUFLLElBQUksSUFBSTtZQUMzQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU87WUFDckMsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPO1NBQzdCLENBQUM7UUFDRixRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDakIsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBRUQsTUFBTSxVQUFVLFFBQVEsQ0FBQyxJQUFvQixFQUFFLFVBQXVCO0lBRXBFLE9BQU8sQ0FBQyxHQUFHLENBQUM7UUFDVixnQkFBZ0IsQ0FBQyxNQUFNLENBQUM7WUFDdEIsSUFBSSxFQUFFLGlCQUFpQjtZQUN2QixXQUFXLEVBQUUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3hDLFlBQVksRUFBRSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDdkMsVUFBVSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUM7U0FDN0IsQ0FBQztRQUNGLFlBQVksQ0FBQyxNQUFNLENBQUM7WUFDbEIsSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQztZQUN4QixXQUFXLEVBQUUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3hDLFlBQVksRUFBRSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDdkMsVUFBVSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUM7U0FDN0IsQ0FBQztLQUNILENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtRQUNsQixJQUFJLFVBQVUsR0FBWSxFQUFFLENBQUE7UUFDNUIsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3BDLFVBQVUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtTQUMvQzthQUFNO1lBQ0wsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUU7Z0JBQ3BCLFVBQVUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO2FBQ25DO1lBQ0QsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQ2hCLFVBQVUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO2FBQ25DO1NBQ0Y7UUFFRCxVQUFVLENBQUMsVUFBVSxFQUFFLFVBQVUsSUFBSSxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyxDQUFBO1FBQ3ZGLHdCQUF3QixDQUFDLFVBQVUsRUFBRSxDQUFBLFVBQVUsYUFBVixVQUFVLHVCQUFWLFVBQVUsQ0FBRSxLQUFLLEtBQUksaUJBQWlCLENBQUMsQ0FBQztRQUM3RSxrQkFBa0IsRUFBRSxDQUFDO1FBRXJCLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFxQixDQUFDO1FBQ2pFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRTtZQUNwQyxDQUFDLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDbkIsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLE1BQTBCLENBQUM7WUFDNUMsUUFBUSxNQUFNLENBQUMsS0FBSyxFQUFFO2dCQUNwQixLQUFLLGlCQUFpQjtvQkFDcEIsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztvQkFDOUQsTUFBTTtnQkFDUixLQUFLLGlCQUFpQjtvQkFDcEIsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7b0JBQzdELE1BQU07Z0JBQ1IsS0FBSyxlQUFlO29CQUNsQixRQUFRLENBQUMsSUFBSSxFQUFFLEVBQUUsR0FBRyxFQUFFLFlBQVksRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztvQkFDbEUsTUFBTTthQUNUO1FBRUgsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDLENBQUMsQ0FBQTtBQUVKLENBQUM7QUFFRCxNQUFNLFVBQVUscUJBQXFCLENBQUMsSUFBb0I7SUFDeEQsSUFBSSxXQUFXLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUM3QixJQUFJLE9BQU8sR0FBRyxHQUFHLFdBQVcsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO0lBQ3hILElBQUksV0FBVyxHQUFHLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsRUFBRSxXQUFXLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3JGLElBQUksT0FBTyxHQUFHLEdBQUcsV0FBVyxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksV0FBVyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUM7SUFDeEgsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7UUFDbkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7S0FDeEs7SUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRTtRQUNqQixJQUFJLENBQUMsT0FBTyxHQUFHLEdBQUcsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztLQUN0SztJQUVELFdBQVcsQ0FDVCxtQkFBbUIsRUFDbkI7Ozs7Ozs7Ozs7Ozs7Ozs7OzJEQWlCdUQsSUFBSSxDQUFDLFNBQVMsVUFBVSxPQUFPLFVBQVUsT0FBTzs7Ozs0REFJL0MsSUFBSSxDQUFDLE9BQU8sVUFBVSxJQUFJLENBQUMsU0FBUyxVQUFVLE9BQU87Ozs7Ozs7Ozs7OztLQVk1RyxDQUNGLENBQUE7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVuZGVyQmxvY2sgfSBmcm9tICcuL2xpYi5qcyc7XG5pbXBvcnQgeyBQbGFjZSB9IGZyb20gJy4vc3RvcmUvZG9tYWluL3BsYWNlLmpzJztcbmltcG9ydCB7IHJlbmRlclNlYXJjaFJlc3VsdHNCbG9jayB9IGZyb20gJy4vc2VhcmNoLXJlc3VsdHMuanMnO1xuaW1wb3J0IHsgRmxhdHJlbnRQcm92aWRlciB9IGZyb20gJy4vc3RvcmUvcHJvdmlkZXJzL2ZsYXRyZW50L2ZsYXRyZW50LXByb3ZpZGVyLmpzJztcbmltcG9ydCB7IEhvbXlQcm92aWRlciB9IGZyb20gJy4vc3RvcmUvcHJvdmlkZXJzL2hvbXkvaG9teS1wcm92aWRlci5qcyc7XG5pbXBvcnQgeyB0b2dnbGVGYXZvcml0ZUl0ZW0gfSBmcm9tICcuL3RvZ2dsZUZhdm9yaXRlLmpzJztcblxuY29uc3QgZmxhdHJlbnRQcm92aWRlciA9IG5ldyBGbGF0cmVudFByb3ZpZGVyKClcbmNvbnN0IGhvbXlQcm92aWRlciA9IG5ldyBIb215UHJvdmlkZXIoKVxuXG5leHBvcnQgaW50ZXJmYWNlIFNlYXJjaEZvcm1EYXRhIHtcbiAgc3RhcnREYXRlOiBzdHJpbmcsXG4gIGVuZERhdGU6IHN0cmluZyxcbiAgbWF4UHJpY2U/OiBudW1iZXIsXG4gIGZsYXRSZW50PzogYm9vbGVhbixcbiAgaG9teT86IGJvb2xlYW5cbn1cblxuZXhwb3J0IGludGVyZmFjZSBTb3J0UGFyYW1zIHtcbiAga2V5OiBzdHJpbmcsXG4gIGJ5OiBudW1iZXIsXG4gIHZhbHVlOiBzdHJpbmdcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIENhbGxCYWNrKHZhbHVlOiBzdHJpbmcgfCBQbGFjZSkge1xuICBpZiAoTWF0aC5yYW5kb20oKSA+PSAwLjUpIHtcbiAgICB0aHJvdyBFcnJvcihcInZhbHVlXCIpOztcbiAgfVxuICByZXR1cm4gW11cbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBzb3J0UGxhY2VzKGFycjogUGxhY2VbXSwgc29ydDogU29ydFBhcmFtcykge1xuICBmdW5jdGlvbiBzb3J0Qnkob25lOiBQbGFjZSwgdHdvOiBQbGFjZSkge1xuICAgIGlmIChvbmVbc29ydC5rZXldID4gdHdvW3NvcnQua2V5XSkge1xuICAgICAgcmV0dXJuIHNvcnQuYnlcbiAgICB9IGVsc2UgaWYgKG9uZVtzb3J0LmtleV0gPCB0d29bc29ydC5rZXldKSB7XG4gICAgICByZXR1cm4gLXNvcnQuYnlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIDBcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGFyci5zb3J0KHNvcnRCeSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlYXJjaChmb3JtTmFtZTogc3RyaW5nLCBjYjogRnVuY3Rpb24gPSBmdW5jdGlvbiAoKSB7IH0pIHtcbiAgY29uc3QgZm9ybSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGZvcm1OYW1lKTtcblxuICBjb25zdCBkYXRhID0ge1xuICAgICdzdGFydERhdGUnOiBmb3JtWydjaGVjay1pbi1kYXRlJ10udmFsdWUsXG4gICAgJ2VuZERhdGUnOiBmb3JtWydjaGVjay1vdXQtZGF0ZSddLnZhbHVlLFxuICAgICdmbGF0UmVudCc6IGZvcm1bJ2ZsYXQtcmVudCddLmNoZWNrZWQsXG4gICAgJ2hvbXknOiBmb3JtWydob215J10uY2hlY2tlZFxuICB9O1xuICBmaW5kRGF0YShkYXRhKTtcbiAgc2V0VGltZW91dChjYiwgMzAwMCk7XG4gIGZvcm0uYWRkRXZlbnRMaXN0ZW5lcignc3VibWl0JywgKGUpID0+IHtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgbGV0IGRhdGEgPSB7XG4gICAgICAnc3RhcnREYXRlJzogZm9ybVsnY2hlY2staW4tZGF0ZSddLnZhbHVlLFxuICAgICAgJ2VuZERhdGUnOiBmb3JtWydjaGVjay1vdXQtZGF0ZSddLnZhbHVlLFxuICAgICAgJ21heFByaWNlJzogZm9ybVsnbWF4LXByaWNlJ10udmFsdWUgfHwgbnVsbCxcbiAgICAgICdmbGF0UmVudCc6IGZvcm1bJ2ZsYXQtcmVudCddLmNoZWNrZWQsXG4gICAgICAnaG9teSc6IGZvcm1bJ2hvbXknXS5jaGVja2VkXG4gICAgfTtcbiAgICBmaW5kRGF0YShkYXRhKTtcbiAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbmREYXRhKGRhdGE6IFNlYXJjaEZvcm1EYXRhLCBzb3J0UGFyYW1zPzogU29ydFBhcmFtcyk6IHZvaWQge1xuXG4gIFByb21pc2UuYWxsKFtcbiAgICBmbGF0cmVudFByb3ZpZGVyLnNlYXJjaCh7XG4gICAgICBjaXR5OiAn0KHQsNC90LrRgi3Qn9C10YLQtdGA0LHRg9GA0LMnLFxuICAgICAgY2hlY2tJbkRhdGU6IG5ldyBEYXRlKGRhdGFbJ3N0YXJ0RGF0ZSddKSxcbiAgICAgIGNoZWNrT3V0RGF0ZTogbmV3IERhdGUoZGF0YVsnZW5kRGF0ZSddKSxcbiAgICAgIHByaWNlTGltaXQ6IGRhdGFbJ21heFByaWNlJ11cbiAgICB9KSxcbiAgICBob215UHJvdmlkZXIuc2VhcmNoKHtcbiAgICAgIGNpdHk6IFs1OS45Mzg2LCAzMC4zMTQxXSxcbiAgICAgIGNoZWNrSW5EYXRlOiBuZXcgRGF0ZShkYXRhWydzdGFydERhdGUnXSksXG4gICAgICBjaGVja091dERhdGU6IG5ldyBEYXRlKGRhdGFbJ2VuZERhdGUnXSksXG4gICAgICBwcmljZUxpbWl0OiBkYXRhWydtYXhQcmljZSddXG4gICAgfSlcbiAgXSkudGhlbigocmVzdWx0cykgPT4ge1xuICAgIGxldCBhbGxSZXN1bHRzOiBQbGFjZVtdID0gW11cbiAgICBpZiAoZGF0YVsnZmxhdFJlbnQnXSAmJiBkYXRhWydob215J10pIHtcbiAgICAgIGFsbFJlc3VsdHMgPSBbXS5jb25jYXQocmVzdWx0c1swXSwgcmVzdWx0c1sxXSlcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGRhdGFbJ2ZsYXRSZW50J10pIHtcbiAgICAgICAgYWxsUmVzdWx0cyA9IFtdLmNvbmNhdChyZXN1bHRzWzBdKVxuICAgICAgfVxuICAgICAgaWYgKGRhdGFbJ2hvbXknXSkge1xuICAgICAgICBhbGxSZXN1bHRzID0gW10uY29uY2F0KHJlc3VsdHNbMV0pXG4gICAgICB9XG4gICAgfVxuXG4gICAgc29ydFBsYWNlcyhhbGxSZXN1bHRzLCBzb3J0UGFyYW1zIHx8IHsga2V5OiBcInByaWNlXCIsIGJ5OiAxLCB2YWx1ZTogXCLQodC90LDRh9Cw0LvQsCDQtNC10YjRkdCy0YvQtVwiIH0pXG4gICAgcmVuZGVyU2VhcmNoUmVzdWx0c0Jsb2NrKGFsbFJlc3VsdHMsIHNvcnRQYXJhbXM/LnZhbHVlIHx8IFwi0KHQvdCw0YfQsNC70LAg0LTQtdGI0ZHQstGL0LVcIik7XG4gICAgdG9nZ2xlRmF2b3JpdGVJdGVtKCk7XG5cbiAgICBjb25zdCBzb3J0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJzb3J0XCIpIGFzIEhUTUxJbnB1dEVsZW1lbnQ7XG4gICAgc29ydC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4ge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgY29uc3QgdGFyZ2V0ID0gZS50YXJnZXQgYXMgSFRNTElucHV0RWxlbWVudDtcbiAgICAgIHN3aXRjaCAodGFyZ2V0LnZhbHVlKSB7XG4gICAgICAgIGNhc2UgXCLQodC90LDRh9Cw0LvQsCDQtNC+0YDQvtCz0LjQtVwiOlxuICAgICAgICAgIGZpbmREYXRhKGRhdGEsIHsga2V5OiBcInByaWNlXCIsIGJ5OiAtMSwgdmFsdWU6IHRhcmdldC52YWx1ZSB9KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcItCh0L3QsNGH0LDQu9CwINC00LXRiNGR0LLRi9C1XCI6XG4gICAgICAgICAgZmluZERhdGEoZGF0YSwgeyBrZXk6IFwicHJpY2VcIiwgYnk6IDEsIHZhbHVlOiB0YXJnZXQudmFsdWUgfSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgXCLQodC90LDRh9Cw0LvQsCDQsdC70LjQttC1XCI6XG4gICAgICAgICAgZmluZERhdGEoZGF0YSwgeyBrZXk6IFwicmVtb3RlbmVzc1wiLCBieTogMSwgdmFsdWU6IHRhcmdldC52YWx1ZSB9KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgIH0pXG4gIH0pXG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbmRlclNlYXJjaEZvcm1CbG9jayhkYXRhOiBTZWFyY2hGb3JtRGF0YSkge1xuICBsZXQgY3VycmVudERhdGUgPSBuZXcgRGF0ZSgpO1xuICBsZXQgbWluRGF0ZSA9IGAke2N1cnJlbnREYXRlLmdldEZ1bGxZZWFyKCl9LSR7KCcwJyArIChjdXJyZW50RGF0ZS5nZXRNb250aCgpICsgMSkpLnNsaWNlKC0yKX0tJHtjdXJyZW50RGF0ZS5nZXREYXRlKCl9YDtcbiAgbGV0IG1heERhdGVGdWxsID0gbmV3IERhdGUoY3VycmVudERhdGUuZ2V0RnVsbFllYXIoKSwgY3VycmVudERhdGUuZ2V0TW9udGgoKSArIDIsIDApO1xuICBsZXQgbWF4RGF0ZSA9IGAke21heERhdGVGdWxsLmdldEZ1bGxZZWFyKCl9LSR7KCcwJyArIChtYXhEYXRlRnVsbC5nZXRNb250aCgpICsgMSkpLnNsaWNlKC0yKX0tJHttYXhEYXRlRnVsbC5nZXREYXRlKCl9YDtcbiAgaWYgKCFkYXRhLnN0YXJ0RGF0ZSkge1xuICAgIGRhdGEuc3RhcnREYXRlID0gYCR7bmV3IERhdGUoY3VycmVudERhdGUpLmdldEZ1bGxZZWFyKCl9LSR7KCcwJyArIChjdXJyZW50RGF0ZS5nZXRNb250aCgpICsgMSkpLnNsaWNlKC0yKX0tJHsoJzAnICsgKG5ldyBEYXRlKGN1cnJlbnREYXRlKS5nZXREYXRlKCkgKyAxKSkuc2xpY2UoLTIpfWA7XG4gIH1cbiAgaWYgKCFkYXRhLmVuZERhdGUpIHtcbiAgICBkYXRhLmVuZERhdGUgPSBgJHtuZXcgRGF0ZShjdXJyZW50RGF0ZSkuZ2V0RnVsbFllYXIoKX0tJHsoJzAnICsgKGN1cnJlbnREYXRlLmdldE1vbnRoKCkgKyAxKSkuc2xpY2UoLTIpfS0keygnMCcgKyAobmV3IERhdGUoY3VycmVudERhdGUpLmdldERhdGUoKSArIDIpKS5zbGljZSgtMil9YDtcbiAgfVxuXG4gIHJlbmRlckJsb2NrKFxuICAgICdzZWFyY2gtZm9ybS1ibG9jaycsXG4gICAgYFxuICAgIDxmb3JtIGlkPVwic2VhcmNoXCI+XG4gICAgICA8ZmllbGRzZXQgY2xhc3M9XCJzZWFyY2gtZmlsZWRzZXRcIj5cbiAgICAgICAgPGRpdiBjbGFzcz1cInJvd1wiPlxuICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICA8bGFiZWwgZm9yPVwiY2l0eVwiPtCT0L7RgNC+0LQ8L2xhYmVsPlxuICAgICAgICAgICAgPGlucHV0IGlkPVwiY2l0eVwiIHR5cGU9XCJ0ZXh0XCIgZGlzYWJsZWQgdmFsdWU9XCLQodCw0L3QutGCLdCf0LXRgtC10YDQsdGD0YDQs1wiIC8+XG4gICAgICAgICAgICA8aW5wdXQgdHlwZT1cImhpZGRlblwiIGRpc2FibGVkIHZhbHVlPVwiNTkuOTM4NiwzMC4zMTQxXCIgLz5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8ZGl2IGNsYXNzPVwicHJvdmlkZXJzXCI+XG4gICAgICAgICAgICA8bGFiZWw+PGlucHV0IHR5cGU9XCJjaGVja2JveFwiIG5hbWU9XCJwcm92aWRlclwiIHZhbHVlPVwiaG9teVwiIGlkPVwiaG9teVwiIGNoZWNrZWQgLz4gSG9teTwvbGFiZWw+XG4gICAgICAgICAgICA8bGFiZWw+PGlucHV0IHR5cGU9XCJjaGVja2JveFwiIG5hbWU9XCJwcm92aWRlclwiIHZhbHVlPVwiZmxhdC1yZW50XCIgaWQ9XCJmbGF0LXJlbnRcIiBjaGVja2VkIC8+IEZsYXRSZW50PC9sYWJlbD5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJyb3dcIj5cbiAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgPGxhYmVsIGZvcj1cImNoZWNrLWluLWRhdGVcIj7QlNCw0YLQsCDQt9Cw0LXQt9C00LA8L2xhYmVsPlxuICAgICAgICAgICAgPGlucHV0IGlkPVwiY2hlY2staW4tZGF0ZVwiIHR5cGU9XCJkYXRlXCIgdmFsdWU9XCIke2RhdGEuc3RhcnREYXRlfVwiIG1pbj1cIiR7bWluRGF0ZX1cIiBtYXg9XCIke21heERhdGV9XCIgbmFtZT1cImNoZWNraW5cIiAvPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICA8bGFiZWwgZm9yPVwiY2hlY2stb3V0LWRhdGVcIj7QlNCw0YLQsCDQstGL0LXQt9C00LA8L2xhYmVsPlxuICAgICAgICAgICAgPGlucHV0IGlkPVwiY2hlY2stb3V0LWRhdGVcIiB0eXBlPVwiZGF0ZVwiIHZhbHVlPVwiJHtkYXRhLmVuZERhdGV9XCIgbWluPVwiJHtkYXRhLnN0YXJ0RGF0ZX1cIiBtYXg9XCIke21heERhdGV9XCIgbmFtZT1cImNoZWNrb3V0XCIgLz5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgPGxhYmVsIGZvcj1cIm1heC1wcmljZVwiPtCc0LDQutGBLiDRhtC10L3QsCDRgdGD0YLQvtC6PC9sYWJlbD5cbiAgICAgICAgICAgIDxpbnB1dCBpZD1cIm1heC1wcmljZVwiIHR5cGU9XCJudW1iZXJcIiB2YWx1ZT1cIlwiIG5hbWU9XCJwcmljZVwiIGNsYXNzPVwibWF4LXByaWNlXCIgLz5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgPGRpdj48YnV0dG9uPtCd0LDQudGC0Lg8L2J1dHRvbj48L2Rpdj5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2ZpZWxkc2V0PlxuICAgIDwvZm9ybT5cbiAgICBgXG4gIClcbn1cbiJdfQ==