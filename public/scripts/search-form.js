import { renderBlock } from "./lib.js";
import { renderSearchResultsBlock } from "./search-results.js";
import { FlatrentProvider } from "./store/providers/flatrent/flatrent-provider.js";
import { HomyProvider } from "./store/providers/homy/homy-provider.js";
import { toggleFavoriteItem } from "./toggleFavorite.js";
const flatrentProvider = new FlatrentProvider();
const homyProvider = new HomyProvider();
export function CallBack(value) {
    if (Math.random() >= 0.5) {
        throw Error("value");
    }
    return [];
}
export function sortPlaces(arr, sort) {
    function sortBy(one, two) {
        if (one[sort.key] > two[sort.key]) {
            return sort.by;
        }
        else if (one[sort.key] < two[sort.key]) {
            return -sort.by;
        }
        else {
            return 0;
        }
    }
    return arr.sort(sortBy);
}
export function search(formName, cb = function () { }) {
    const form = document.getElementById(formName);
    const data = {
        startDate: document.getElementById("check-in-date")
            .value,
        endDate: document.getElementById("check-out-date")
            .value,
        flatRent: document.getElementById("flat-rent")
            .checked,
        homy: document.getElementById("homy").checked,
    };
    findData(data);
    setTimeout(cb, 3000);
    form.addEventListener("submit", (e) => {
        e.preventDefault();
        let data = {
            startDate: document.getElementById("check-in-date")
                .value,
            endDate: document.getElementById("check-out-date")
                .value,
            maxPrice: +document.getElementById("max-price").value ||
                null,
            flatRent: document.getElementById("flat-rent")
                .checked,
            homy: document.getElementById("homy").checked,
        };
        findData(data);
    });
}
export function findData(data, sortParams) {
    Promise.all([
        flatrentProvider.search({
            city: "Санкт-Петербург",
            checkInDate: new Date(data["startDate"]),
            checkOutDate: new Date(data["endDate"]),
            priceLimit: data["maxPrice"],
        }),
        homyProvider.search({
            city: [59.9386, 30.3141],
            checkInDate: new Date(data["startDate"]),
            checkOutDate: new Date(data["endDate"]),
            priceLimit: data["maxPrice"],
        }),
    ]).then((results) => {
        let allResults = [];
        if (data["flatRent"] && data["homy"]) {
            allResults = [].concat(results[0], results[1]);
        }
        else {
            if (data["flatRent"]) {
                allResults = [].concat(results[0]);
            }
            if (data["homy"]) {
                allResults = [].concat(results[1]);
            }
        }
        sortPlaces(allResults, sortParams || { key: "price", by: 1, value: "Сначала дешёвые" });
        renderSearchResultsBlock(allResults, (sortParams === null || sortParams === void 0 ? void 0 : sortParams.value) || "Сначала дешёвые");
        toggleFavoriteItem();
        const sort = document.getElementById("sort");
        sort.addEventListener("change", (e) => {
            e.preventDefault();
            const target = e.target;
            switch (target.value) {
                case "Сначала дорогие":
                    findData(data, { key: "price", by: -1, value: target.value });
                    break;
                case "Сначала дешёвые":
                    findData(data, { key: "price", by: 1, value: target.value });
                    break;
                case "Сначала ближе":
                    findData(data, { key: "remoteness", by: 1, value: target.value });
                    break;
            }
        });
    });
}
export function renderSearchFormBlock(data) {
    let currentDate = new Date();
    let minDate = `${currentDate.getFullYear()}-${("0" +
        (currentDate.getMonth() + 1)).slice(-2)}-${currentDate.getDate()}`;
    let maxDateFull = new Date(currentDate.getFullYear(), currentDate.getMonth() + 2, 0);
    let maxDate = `${maxDateFull.getFullYear()}-${("0" +
        (maxDateFull.getMonth() + 1)).slice(-2)}-${maxDateFull.getDate()}`;
    if (!data.startDate) {
        data.startDate = `${new Date(currentDate).getFullYear()}-${("0" +
            (currentDate.getMonth() + 1)).slice(-2)}-${("0" + (new Date(currentDate).getDate() + 1)).slice(-2)}`;
    }
    if (!data.endDate) {
        data.endDate = `${new Date(currentDate).getFullYear()}-${("0" +
            (currentDate.getMonth() + 1)).slice(-2)}-${("0" + (new Date(currentDate).getDate() + 2)).slice(-2)}`;
    }
    renderBlock("search-form-block", `
    <form id="search">
      <fieldset class="search-filedset">
        <div class="row">
          <div>
            <label for="city">Город</label>
            <input id="city" type="text" disabled value="Санкт-Петербург" />
            <input type="hidden" disabled value="59.9386,30.3141" />
          </div>
          <div class="providers">
            <label><input type="checkbox" name="provider" value="homy" id="homy" checked /> Homy</label>
            <label><input type="checkbox" name="provider" value="flat-rent" id="flat-rent" checked /> FlatRent</label>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="check-in-date">Дата заезда</label>
            <input id="check-in-date" type="date" value="${data.startDate}" min="${minDate}" max="${maxDate}" name="checkin" />
          </div>
          <div>
            <label for="check-out-date">Дата выезда</label>
            <input id="check-out-date" type="date" value="${data.endDate}" min="${data.startDate}" max="${maxDate}" name="checkout" />
          </div>
	@@ -167,5 +209,5 @@
      </fieldset>
    </form>
    `);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLWZvcm0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2VhcmNoLWZvcm0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN2QyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpREFBaUQsQ0FBQztBQUNuRixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFDdkUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFekQsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLGdCQUFnQixFQUFFLENBQUM7QUFDaEQsTUFBTSxZQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztBQTRCeEMsTUFBTSxVQUFVLFFBQVEsQ0FBQyxLQUFxQjtJQUM1QyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxHQUFHLEVBQUU7UUFDeEIsTUFBTSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDdEI7SUFDRCxPQUFPLEVBQUUsQ0FBQztBQUNaLENBQUM7QUFFRCxNQUFNLFVBQVUsVUFBVSxDQUFDLEdBQVksRUFBRSxJQUFpQjtJQUN4RCxTQUFTLE1BQU0sQ0FBQyxHQUFRLEVBQUUsR0FBUTtRQUNoQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNqQyxPQUFPLElBQUksQ0FBQyxFQUFFLENBQUM7U0FDaEI7YUFBTSxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUN4QyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztTQUNqQjthQUFNO1lBQ0wsT0FB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QUFHLENBQUMsQ0FBQyxDQUM3QixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0tBQzFFO0lBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUU7UUFDakIsSUFBSSxDQUFDLE9BQU8sR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQ3ZELEdBQUc7WUFDSCxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FDN0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztLQUMxRTtJQUVELFdBQVcsQ0FDVCxtQkFBbUIsRUFDbkI7Ozs7Ozs7Ozs7Ozs7Ozs7OzJEQWlCdUQsSUFBSSxDQUFDLFNBQVMsVUFBVSxPQUFPLFVBQVUsT0FBTzs7Ozs0REFJL0MsSUFBSSxDQUFDLE9BQU8sVUFBVSxJQUFJLENBQUMsU0FBUyxVQUFVLE9BQU87Ozs7O0tBSzVHLENBQ0YsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQbGFjZSB9IGZyb20gXCIuL3N0b3JlL2RvbWFpbi9wbGFjZS5qc1wiO1xuaW1wb3J0IHsgcmVuZGVyQmxvY2sgfSBmcm9tIFwiLi9saWIuanNcIjtcbmltcG9ydCB7IHJlbmRlclNlYXJjaFJlc3VsdHNCbG9jayB9IGZyb20gXCIuL3NlYXJjaC1yZXN1bHRzLmpzXCI7XG5pbXBvcnQgeyBGbGF0cmVudFByb3ZpZGVyIH0gZnJvbSBcIi4vc3RvcmUvcHJvdmlkZXJzL2ZsYXRyZW50L2ZsYXRyZW50LXByb3ZpZGVyLmpzXCI7XG5pbXBvcnQgeyBIb215UHJvdmlkZXIgfSBmcm9tIFwiLi9zdG9yZS9wcm92aWRlcnMvaG9teS9ob215LXByb3ZpZGVyLmpzXCI7XG5pbXBvcnQgeyB0b2dnbGVGYXZvcml0ZUl0ZW0gfSBmcm9tIFwiLi90b2dnbGVGYXZvcml0ZS5qc1wiO1xuXG5jb25zdCBmbGF0cmVudFByb3ZpZGVyID0gbmV3IEZsYXRyZW50UHJvdmlkZXIoKTtcbmNvbnN0IGhvbXlQcm92aWRlciA9IG5ldyBIb215UHJvdmlkZXIoKTtcblxuZXhwb3J0IGludGVyZmFjZSBpU2VhcmNoRm9ybURhdGEge1xuICBzdGFydERhdGU6IHN0cmluZztcbiAgZW5kRGF0ZTogc3RyaW5nO1xuICBtYXhQcmljZT86IG51bWJlcjtcbiAgZmxhdFJlbnQ/OiBib29sZWFuO1xuICBob215PzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBpUGxhY2Uge1xuICBwcm92aWRlcjogc3RyaW5nO1xuICBvcmlnaW5hbElkOiBzdHJpbmc7XG4gIGltYWdlOiBzdHJpbmc7XG4gIG5hbWU6IHN0cmluZztcbiAgZGVzY3JpcHRpb246IHN0cmluZztcbiAgcmVtb3RlbmVzczogbnVtYmVyO1xuICBwcmljZTogbnVtYmVyO1xuICBib29rZWREYXRlczogRGF0ZVtdIHwgbnVtYmVyW107XG4gIGNvb3JkaW5hdGVzPzogbnVtYmVyW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNvcnRQYXJhbXMge1xuICBrZXk6IHN0cmluZztcbiAgYnk6IG51bWJlcjtcbiAgdmFsdWU6IHN0cmluZztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIENhbGxCYWNrKHZhbHVlOiBzdHJpbmcgfCBQbGFjZSk6IEVycm9yIHwgW10ge1xuICBpZiAoTWF0aC5yYW5kb20oKSA+PSAwLjUpIHtcbiAgICB0aHJvdyBFcnJvcihcInZhbHVlXCIpO1xuICB9XG4gIHJldHVybiBbXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNvcnRQbGFjZXMoYXJyOiBQbGFjZVtdLCBzb3J0OiBpU29ydFBhcmFtcykge1xuICBmdW5jdGlvbiBzb3J0Qnkob25lOiBhbnksIHR3bzogYW55KSB7XG4gICAgaWYgKG9uZVtzb3J0LmtleV0gPiB0d29bc29ydC5rZXldKSB7XG4gICAgICByZXR1cm4gc29ydC5ieTtcbiAgICB9IGVsc2UgaWYgKG9uZVtzb3J0LmtleV0gPCB0d29bc29ydC5rZXldKSB7XG4gICAgICByZXR1cm4gLXNvcnQuYnk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgfVxuICByZXR1cm4gYXJyLnNvcnQoc29ydEJ5KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlYXJjaChmb3JtTmFtZTogc3RyaW5nLCBjYjogRnVuY3Rpb24gPSBmdW5jdGlvbiAoKSB7IH0pIHtcbiAgY29uc3QgZm9ybSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGZvcm1OYW1lKTtcblxuICBjb25zdCBkYXRhID0ge1xuICAgIHN0YXJ0RGF0ZTogKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiY2hlY2staW4tZGF0ZVwiKSBhcyBIVE1MSW5wdXRFbGVtZW50KVxuICAgICAgLnZhbHVlLFxuICAgIGVuZERhdGU6IChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImNoZWNrLW91dC1kYXRlXCIpIGFzIEhUTUxJbnB1dEVsZW1lbnQpXG4gICAgICAudmFsdWUsXG4gICAgZmxhdFJlbnQ6IChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImZsYXQtcmVudFwiKSBhcyBIVE1MSW5wdXRFbGVtZW50KVxuICAgICAgLmNoZWNrZWQsXG4gICAgaG9teTogKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiaG9teVwiKSBhcyBIVE1MSW5wdXRFbGVtZW50KS5jaGVja2VkLFxuICB9O1xuICBmaW5kRGF0YShkYXRhKTtcbiAgc2V0VGltZW91dChjYiwgMzAwMCk7XG4gIGZvcm0uYWRkRXZlbnRMaXN0ZW5lcihcInN1Ym1pdFwiLCAoZSkgPT4ge1xuICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICBsZXQgZGF0YSA9IHtcbiAgICAgIHN0YXJ0RGF0ZTogKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiY2hlY2staW4tZGF0ZVwiKSBhcyBIVE1MSW5wdXRFbGVtZW50KVxuICAgICAgICAudmFsdWUsXG4gICAgICBlbmREYXRlOiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJjaGVjay1vdXQtZGF0ZVwiKSBhcyBIVE1MSW5wdXRFbGVtZW50KVxuICAgICAgICAudmFsdWUsXG4gICAgICBtYXhQcmljZTpcbiAgICAgICAgKyhkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIm1heC1wcmljZVwiKSBhcyBIVE1MSW5wdXRFbGVtZW50KS52YWx1ZSB8fFxuICAgICAgICBudWxsLFxuICAgICAgZmxhdFJlbnQ6IChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImZsYXQtcmVudFwiKSBhcyBIVE1MSW5wdXRFbGVtZW50KVxuICAgICAgICAuY2hlY2tlZCxcbiAgICAgIGhvbXk6IChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImhvbXlcIikgYXMgSFRNTElucHV0RWxlbWVudCkuY2hlY2tlZCxcbiAgICB9O1xuICAgIGZpbmREYXRhKGRhdGEpO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbmREYXRhKFxuICBkYXRhOiBpU2VhcmNoRm9ybURhdGEsXG4gIHNvcnRQYXJhbXM/OiBpU29ydFBhcmFtc1xuKTogdm9pZCB7XG4gIFByb21pc2UuYWxsKFtcbiAgICBmbGF0cmVudFByb3ZpZGVyLnNlYXJjaCh7XG4gICAgICBjaXR5OiBcItCh0LDQvdC60YIt0J/QtdGC0LXRgNCx0YPRgNCzXCIsXG4gICAgICBjaGVja0luRGF0ZTogbmV3IERhdGUoZGF0YVtcInN0YXJ0RGF0ZVwiXSksXG4gICAgICBjaGVja091dERhdGU6IG5ldyBEYXRlKGRhdGFbXCJlbmREYXRlXCJdKSxcbiAgICAgIHByaWNlTGltaXQ6IGRhdGFbXCJtYXhQcmljZVwiXSxcbiAgICB9KSxcbiAgICBob215UHJvdmlkZXIuc2VhcmNoKHtcbiAgICAgIGNpdHk6IFs1OS45Mzg2LCAzMC4zMTQxXSxcbiAgICAgIGNoZWNrSW5EYXRlOiBuZXcgRGF0ZShkYXRhW1wic3RhcnREYXRlXCJdKSxcbiAgICAgIGNoZWNrT3V0RGF0ZTogbmV3IERhdGUoZGF0YVtcImVuZERhdGVcIl0pLFxuICAgICAgcHJpY2VMaW1pdDogZGF0YVtcIm1heFByaWNlXCJdLFxuICAgIH0pLFxuICBdKS50aGVuKChyZXN1bHRzKSA9PiB7XG4gICAgbGV0IGFsbFJlc3VsdHM6IFBsYWNlW10gPSBbXTtcbiAgICBpZiAoZGF0YVtcImZsYXRSZW50XCJdICYmIGRhdGFbXCJob215XCJdKSB7XG4gICAgICBhbGxSZXN1bHRzID0gW10uY29uY2F0KHJlc3VsdHNbMF0sIHJlc3VsdHNbMV0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZGF0YVtcImZsYXRSZW50XCJdKSB7XG4gICAgICAgIGFsbFJlc3VsdHMgPSBbXS5jb25jYXQocmVzdWx0c1swXSk7XG4gICAgICB9XG4gICAgICBpZiAoZGF0YVtcImhvbXlcIl0pIHtcbiAgICAgICAgYWxsUmVzdWx0cyA9IFtdLmNvbmNhdChyZXN1bHRzWzFdKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBzb3J0UGxhY2VzKFxuICAgICAgYWxsUmVzdWx0cyxcbiAgICAgIHNvcnRQYXJhbXMgfHwgeyBrZXk6IFwicHJpY2VcIiwgYnk6IDEsIHZhbHVlOiBcItCh0L3QsNGH0LDQu9CwINC00LXRiNGR0LLRi9C1XCIgfVxuICAgICk7XG4gICAgcmVuZGVyU2VhcmNoUmVzdWx0c0Jsb2NrKFxuICAgICAgYWxsUmVzdWx0cyxcbiAgICAgIHNvcnRQYXJhbXM/LnZhbHVlIHx8IFwi0KHQvdCw0YfQsNC70LAg0LTQtdGI0ZHQstGL0LVcIlxuICAgICk7XG4gICAgdG9nZ2xlRmF2b3JpdGVJdGVtKCk7XG5cbiAgICBjb25zdCBzb3J0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJzb3J0XCIpIGFzIEhUTUxJbnB1dEVsZW1lbnQ7XG4gICAgc29ydC5hZGRFdmVudExpc3RlbmVyKFwiY2hhbmdlXCIsIChlKSA9PiB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBjb25zdCB0YXJnZXQgPSBlLnRhcmdldCBhcyBIVE1MSW5wdXRFbGVtZW50O1xuICAgICAgc3dpdGNoICh0YXJnZXQudmFsdWUpIHtcbiAgICAgICAgY2FzZSBcItCh0L3QsNGH0LDQu9CwINC00L7RgNC+0LPQuNC1XCI6XG4gICAgICAgICAgZmluZERhdGEoZGF0YSwgeyBrZXk6IFwicHJpY2VcIiwgYnk6IC0xLCB2YWx1ZTogdGFyZ2V0LnZhbHVlIH0pO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwi0KHQvdCw0YfQsNC70LAg0LTQtdGI0ZHQstGL0LVcIjpcbiAgICAgICAgICBmaW5kRGF0YShkYXRhLCB7IGtleTogXCJwcmljZVwiLCBieTogMSwgdmFsdWU6IHRhcmdldC52YWx1ZSB9KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcItCh0L3QsNGH0LDQu9CwINCx0LvQuNC20LVcIjpcbiAgICAgICAgICBmaW5kRGF0YShkYXRhLCB7IGtleTogXCJyZW1vdGVuZXNzXCIsIGJ5OiAxLCB2YWx1ZTogdGFyZ2V0LnZhbHVlIH0pO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbmRlclNlYXJjaEZvcm1CbG9jayhkYXRhOiBpU2VhcmNoRm9ybURhdGEpIHtcbiAgbGV0IGN1cnJlbnREYXRlID0gbmV3IERhdGUoKTtcbiAgbGV0IG1pbkRhdGUgPSBgJHtjdXJyZW50RGF0ZS5nZXRGdWxsWWVhcigpfS0keyhcbiAgICBcIjBcIiArXG4gICAgKGN1cnJlbnREYXRlLmdldE1vbnRoKCkgKyAxKVxuICApLnNsaWNlKC0yKX0tJHtjdXJyZW50RGF0ZS5nZXREYXRlKCl9YDtcbiAgbGV0IG1heERhdGVGdWxsID0gbmV3IERhdGUoXG4gICAgY3VycmVudERhdGUuZ2V0RnVsbFllYXIoKSxcbiAgICBjdXJyZW50RGF0ZS5nZXRNb250aCgpICsgMixcbiAgICAwXG4gICk7XG4gIGxldCBtYXhEYXRlID0gYCR7bWF4RGF0ZUZ1bGwuZ2V0RnVsbFllYXIoKX0tJHsoXG4gICAgXCIwXCIgK1xuICAgIChtYXhEYXRlRnVsbC5nZXRNb250aCgpICsgMSlcbiAgKS5zbGljZSgtMil9LSR7bWF4RGF0ZUZ1bGwuZ2V0RGF0ZSgpfWA7XG4gIGlmICghZGF0YS5zdGFydERhdGUpIHtcbiAgICBkYXRhLnN0YXJ0RGF0ZSA9IGAke25ldyBEYXRlKGN1cnJlbnREYXRlKS5nZXRGdWxsWWVhcigpfS0keyhcbiAgICAgIFwiMFwiICtcbiAgICAgIChjdXJyZW50RGF0ZS5nZXRNb250aCgpICsgMSlcbiAgICApLnNsaWNlKC0yKX0tJHsoXCIwXCIgKyAobmV3IERhdGUoY3VycmVudERhdGUpLmdldERhdGUoKSArIDEpKS5zbGljZSgtMil9YDtcbiAgfVxuICBpZiAoIWRhdGEuZW5kRGF0ZSkge1xuICAgIGRhdGEuZW5kRGF0ZSA9IGAke25ldyBEYXRlKGN1cnJlbnREYXRlKS5nZXRGdWxsWWVhcigpfS0keyhcbiAgICAgIFwiMFwiICtcbiAgICAgIChjdXJyZW50RGF0ZS5nZXRNb250aCgpICsgMSlcbiAgICApLnNsaWNlKC0yKX0tJHsoXCIwXCIgKyAobmV3IERhdGUoY3VycmVudERhdGUpLmdldERhdGUoKSArIDIpKS5zbGljZSgtMil9YDtcbiAgfVxuXG4gIHJlbmRlckJsb2NrKFxuICAgIFwic2VhcmNoLWZvcm0tYmxvY2tcIixcbiAgICBgXG4gICAgPGZvcm0gaWQ9XCJzZWFyY2hcIj5cbiAgICAgIDxmaWVsZHNldCBjbGFzcz1cInNlYXJjaC1maWxlZHNldFwiPlxuICAgICAgICA8ZGl2IGNsYXNzPVwicm93XCI+XG4gICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgIDxsYWJlbCBmb3I9XCJjaXR5XCI+0JPQvtGA0L7QtDwvbGFiZWw+XG4gICAgICAgICAgICA8aW5wdXQgaWQ9XCJjaXR5XCIgdHlwZT1cInRleHRcIiBkaXNhYmxlZCB2YWx1ZT1cItCh0LDQvdC60YIt0J/QtdGC0LXRgNCx0YPRgNCzXCIgLz5cbiAgICAgICAgICAgIDxpbnB1dCB0eXBlPVwiaGlkZGVuXCIgZGlzYWJsZWQgdmFsdWU9XCI1OS45Mzg2LDMwLjMxNDFcIiAvPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDxkaXYgY2xhc3M9XCJwcm92aWRlcnNcIj5cbiAgICAgICAgICAgIDxsYWJlbD48aW5wdXQgdHlwZT1cImNoZWNrYm94XCIgbmFtZT1cInByb3ZpZGVyXCIgdmFsdWU9XCJob215XCIgaWQ9XCJob215XCIgY2hlY2tlZCAvPiBIb215PC9sYWJlbD5cbiAgICAgICAgICAgIDxsYWJlbD48aW5wdXQgdHlwZT1cImNoZWNrYm94XCIgbmFtZT1cInByb3ZpZGVyXCIgdmFsdWU9XCJmbGF0LXJlbnRcIiBpZD1cImZsYXQtcmVudFwiIGNoZWNrZWQgLz4gRmxhdFJlbnQ8L2xhYmVsPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L2Rpdj5cbiAgICAgICAgPGRpdiBjbGFzcz1cInJvd1wiPlxuICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICA8bGFiZWwgZm9yPVwiY2hlY2staW4tZGF0ZVwiPtCU0LDRgtCwINC30LDQtdC30LTQsDwvbGFiZWw+XG4gICAgICAgICAgICA8aW5wdXQgaWQ9XCJjaGVjay1pbi1kYXRlXCIgdHlwZT1cImRhdGVcIiB2YWx1ZT1cIiR7ZGF0YS5zdGFydERhdGV9XCIgbWluPVwiJHttaW5EYXRlfVwiIG1heD1cIiR7bWF4RGF0ZX1cIiBuYW1lPVwiY2hlY2tpblwiIC8+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgIDxsYWJlbCBmb3I9XCJjaGVjay1vdXQtZGF0ZVwiPtCU0LDRgtCwINCy0YvQtdC30LTQsDwvbGFiZWw+XG4gICAgICAgICAgICA8aW5wdXQgaWQ9XCJjaGVjay1vdXQtZGF0ZVwiIHR5cGU9XCJkYXRlXCIgdmFsdWU9XCIke2RhdGEuZW5kRGF0ZX1cIiBtaW49XCIke2RhdGEuc3RhcnREYXRlfVwiIG1heD1cIiR7bWF4RGF0ZX1cIiBuYW1lPVwiY2hlY2tvdXRcIiAvPlxuICAgICAgICAgIDwvZGl2PlxuXHRAQCAtMTY3LDUgKzIwOSw1IEBAXG4gICAgICA8L2ZpZWxkc2V0PlxuICAgIDwvZm9ybT5cbiAgICBgXG4gICk7XG59XG4iXX0=